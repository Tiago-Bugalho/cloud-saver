<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Tiago Cloud Storage</title>
<style>
body{
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:50px 20px;
}
h1{font-size:3em;margin-bottom:20px;text-shadow:2px 2px rgba(0,0,0,0.2);}
input,button{padding:10px;margin:5px;border-radius:5px;border:none;font-size:1em;}
button{cursor:pointer;background:#ff6a00;color:#fff;transition:0.3s;}
button:hover{background:#ee4d00;}
section{background:rgba(0,0,0,0.2);padding:30px;border-radius:15px;margin:20px 0;width:100%;max-width:500px;box-shadow:0 4px 20px rgba(0,0,0,0.3);}
ul{list-style:none;padding:0;}
li{margin:10px 0;display:flex;justify-content:space-between;align-items:center;}
.progress-container{width:100%;background:rgba(255,255,255,0.2);border-radius:5px;margin-top:10px;}
.progress-bar{width:0%;height:15px;background:#00ffd5;border-radius:5px;}
</style>
</head>
<body>
<h1>Tiago Cloud Storage</h1>

<section id="loginSection">
  <input type="text" id="username" placeholder="Usuário">
  <input type="password" id="password" placeholder="Senha">
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Criar Conta</button>
  <p id="loginMsg" style="color:#ffbbbb;"></p>
</section>

<section id="uploadSection" style="display:none;">
  <form id="uploadForm">
    <input type="file" id="fileInput" required>
    <button type="submit">⬆ Enviar Arquivo</button>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  </form>
</section>

<section id="fileSection" style="display:none;">
  <h2>Arquivos disponíveis:</h2>
  <ul id="fileList"></ul>
</section>

<script>
const loginSection=document.getElementById('loginSection');
const uploadSection=document.getElementById('uploadSection');
const fileSection=document.getElementById('fileSection');
const loginBtn=document.getElementById('loginBtn');
const registerBtn=document.getElementById('registerBtn');
const loginMsg=document.getElementById('loginMsg');
const uploadForm=document.getElementById('uploadForm');
const fileInput=document.getElementById('fileInput');
const fileList=document.getElementById('fileList');
const progressBar=document.getElementById('progressBar');

async function authRequest(url,data){
  const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  return res.json();
}

loginBtn.addEventListener('click',async ()=>{
  const username=document.getElementById('username').value;
  const password=document.getElementById('password').value;
  const data=await authRequest('/login',{username,password});
  if(data.success){loginSection.style.display='none';uploadSection.style.display='block';fileSection.style.display='block';startFileRefresh();}
  else loginMsg.textContent="Usuário ou senha incorretos!";
});

registerBtn.addEventListener('click',async ()=>{
  const username=document.getElementById('username').value;
  const password=document.getElementById('password').value;
  const data=await authRequest('/register',{username,password});
  if(data.success){loginMsg.style.color="#bfffbf";loginMsg.textContent="Conta criada com sucesso!";}
  else loginMsg.textContent=data.msg;
});

async function fetchFiles(){
  try{
    const res=await fetch('/files');
    if(res.status===401)return;
    const files=await res.json();
    fileList.innerHTML='';
    files.forEach(file=>{
      const li=document.createElement('li');
      const btn=document.createElement('button');
      btn.textContent=`⬇ ${file}`;
      btn.addEventListener('click',async ()=>{
        const res=await fetch(`/files/${encodeURIComponent(file)}`);
        if(res.ok){
          const blob=await res.blob();
          const url=window.URL.createObjectURL(blob);
          const a=document.createElement('a');
          a.href=url;
          a.download=file;
          a.click();
          window.URL.revokeObjectURL(url);
        }else alert('Erro ao baixar arquivo');
      });
      li.appendChild(btn);
      fileList.appendChild(li);
    });
  }catch(e){console.log(e);}
}

function startFileRefresh(){
  fetchFiles();
  setInterval(fetchFiles,50);
}

uploadForm.addEventListener('submit',async (e)=>{
  e.preventDefault();
  const file=fileInput.files[0];
  if(!file)return;

  const formData=new FormData();
  formData.append('file',file);

  const xhr=new XMLHttpRequest();
  xhr.open('POST','/upload',true);

  xhr.upload.onprogress=function(e){
    if(e.lengthComputable){
      const percent=(e.loaded/e.total)*100;
      progressBar.style.width=percent+'%';
    }
  };

  xhr.onload=function(){
    if(xhr.status===200){alert(xhr.responseText);progressBar.style.width='0%';fileInput.value='';}
    else alert('Erro no upload');
  };

  xhr.send(formData);
});
</script>
</body>
</html>
